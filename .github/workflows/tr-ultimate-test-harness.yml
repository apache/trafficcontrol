# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   https://apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.

name: TR Ultimate Test Harness

env:
  DOCKER_BUILDKIT: '1'
  COMPOSE_DOCKER_CLI_BUILD: '1'

on:
  push:
    paths:
      - .github/actions/tr-ultimate-test-harness/**
      - .github/workflows/tr-ultimate-test-harness.yml
      - dev/traffic_router/**
      - traffic_router/**
  create:
  pull_request:
    paths:
      - .github/actions/tr-ultimate-test-harness/**
      - .github/workflows/tr-ultimate-test-harness.yml
      - dev/traffic_router/**
      - traffic_router/**
    types: [ opened, reopened, ready_for_review, synchronize ]

jobs:
  tests:
    if: github.event.pull_request.draft == false
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@master
      - name: Check Go version
        run: echo "::set-output name=value::$(cat GO_VERSION)"
        id: go-version
      - name: Install Go
        uses: actions/setup-go@v2
        with:
          go-version: ${{ steps.go-version.outputs.value }}
      - name: Vendor dependencies
        run: go mod vendor
      - name: Build docker-compose services
        run: docker-compose build --parallel
      - name: Cache local Maven repository
        uses: actions/cache@v2
        with:
          path: ${{ github.workspace }}/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-
      - name: Cache node modules
        uses: actions/cache@v2
        with:
          path: ${{ github.workspace }}/.npm
          key: ${{ runner.os }}-node-modules-${{ hashFiles('traffic_portal/**/package*.json') }}-
          restore-keys: |
            ${{ runner.os }}-node-modules-
      - name: Run Traffic Router Ultimate Test Harness
        run: ./.github/actions/tr-ultimate-test-harness/tr-ultimate-test-harness.sh
      - name: Write Dev CDN-in-a-Box logs to files
        run: |
          set -o errexit -o nounset
          mkdir -p dev/logs
          for service in $(docker-compose ps --services); do
            docker-compose logs --no-color --timestamps "$service" >"dev/logs/${service}.log"
          done
        if: ${{ failure() }}
      - name: Upload Dev CDN-in-a-Box logs
        uses: actions/upload-artifact@v2
        with:
          name: dev-ciab-logs
          path: dev/logs/*.log
        if: ${{ failure() }}
